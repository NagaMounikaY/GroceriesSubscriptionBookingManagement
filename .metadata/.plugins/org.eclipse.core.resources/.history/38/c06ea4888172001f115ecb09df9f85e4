package com.crimsonlogic.groceriessubbookingsystem.service;

import java.io.File;
import java.io.IOException;
import java.math.BigDecimal;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import com.crimsonlogic.groceriessubbookingsystem.entity.Category;
import com.crimsonlogic.groceriessubbookingsystem.entity.Groceries;
import com.crimsonlogic.groceriessubbookingsystem.repository.CategoryRepository;
import com.crimsonlogic.groceriessubbookingsystem.repository.GroceryRepository;

@Service
public class GroceriesServiceImpl implements GroceriesService {

	@Autowired
	private GroceryRepository groceriesRepository;

	private CategoryRepository categoryRepository;

	private static final String UPLOADED_FOLDER = "uploaded/";

	@Override
	public void saveGrocery(MultipartFile file, String groceryName, String description, BigDecimal groceryPrice,
			int inStock, String categoryId) throws IOException {
		if (file.isEmpty()) {
			throw new IllegalArgumentException("Please select a file to upload");
		}

		// Save the file on the server
		File dir = new File(UPLOADED_FOLDER);
		if (!dir.exists()) {
			dir.mkdirs();
		}
		String fileName = file.getOriginalFilename();
		File serverFile = new File(dir.getAbsolutePath() + File.separator + fileName);
		file.transferTo(serverFile);

		// Retrieve the selected category
		Category category = categoryRepository.findById(categoryId)
				.orElseThrow(() -> new IllegalArgumentException("Invalid category ID"));

		// Create a new grocery item
		Groceries groceries = new Groceries();
		groceries.setGroceryName(groceryName);
		groceries.setDescription(description);
		groceries.setGrocery_price(groceryPrice);
		groceries.setIn_stock(inStock);
		groceries.setImageURL(fileName);
		groceries.setCategory(category); // Set the selected category

		// Save the grocery item to the repository
		groceriesRepository.save(groceries);
	}

	@Override
	public List<Groceries> getAllGroceries() {
		return groceriesRepository.findAll();
	}

	@Override
	public Groceries getGroceryById(String groceryId) {
		return groceriesRepository.findById(groceryId).orElse(null);
	}

	@Override
	public void deleteGrocery(String groceryId) {
		groceriesRepository.deleteById(groceryId);
	}

	public void updateGrocery(String id, MultipartFile file, String groceryName, String description,
			BigDecimal groceryPrice, int inStock, String categoryId) throws IOException {
		Groceries grocery = groceriesRepository.findById(id)
				.orElseThrow(() -> new IllegalArgumentException("Invalid grocery ID"));

		if (file != null && !file.isEmpty()) {
			File dir = new File(UPLOADED_FOLDER);
			if (!dir.exists()) {
				dir.mkdirs();
			}
			String fileName = file.getOriginalFilename();
			File serverFile = new File(dir.getAbsolutePath() + File.separator + fileName);
			file.transferTo(serverFile);
			grocery.setImageURL(fileName);
		}

		grocery.setGroceryName(groceryName);
		grocery.setDescription(description);
		grocery.setGrocery_price(groceryPrice);
		grocery.setIn_stock(inStock);

		Category category = categoryRepository.findById(categoryId)
				.orElseThrow(() -> new IllegalArgumentException("Invalid category ID"));
		grocery.setCategory(category);

		groceriesRepository.save(grocery);
	}

}
