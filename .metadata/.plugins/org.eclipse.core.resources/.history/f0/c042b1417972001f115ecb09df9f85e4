package com.crimsonlogic.groceriessubbookingsystem.controller;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.List;

import javax.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;

import com.crimsonlogic.groceriessubbookingsystem.entity.Groceries;
import com.crimsonlogic.groceriessubbookingsystem.entity.Order;
import com.crimsonlogic.groceriessubbookingsystem.entity.Users;
import com.crimsonlogic.groceriessubbookingsystem.service.GroceriesService;

// Import statements...

import com.crimsonlogic.groceriessubbookingsystem.service.OrderService;

@Controller
@RequestMapping("/orders")
public class OrderController {

    @Autowired
    private OrderService orderService;

    @Autowired
    private GroceriesService groceryService;

    @GetMapping("/viewOrders")
    public String viewOrders(HttpSession session, Model model) {
        Users user = (Users) session.getAttribute("user");
        List<Order> orders;
        if (user != null && "Seller".equals(user.getUserRole())) {
            orders = orderService.getAllOrders();
        } else {
            orders = orderService.getOrdersByUserId(user.getUser_id());
        }
        model.addAttribute("orders", orders);
        model.addAttribute("userId", user != null ? user.getUser_id() : null);
        return "orderList";
    }

    @PostMapping("/updateStatus")
    public String updateOrderStatus(@RequestParam("order_id") String orderId, 
                                     @RequestParam("orderStatus") String status,
                                     HttpSession session, Model model) {
        System.out.println("Order ID: " + orderId);
        System.out.println("Order Status: " + status);

        Order.OrderStatus orderStatus;
        try {
            orderStatus = Order.OrderStatus.valueOf(status);
        } catch (IllegalArgumentException e) {
            model.addAttribute("message", "Invalid status");
            return "orderList";
        }

        orderService.updateOrderStatus(orderId, orderStatus);

        Users user = (Users) session.getAttribute("user");
        if (user == null) {
            model.addAttribute("message", "User not found in session");
            return "orderList";
        }

        List<Order> orders;
        if ("Seller".equals(user.getUserRole())) {
            orders = orderService.getAllOrders();
        } else {
            orders = orderService.getOrdersByUserId(user.getUser_id());
        }
        model.addAttribute("orders", orders);
        model.addAttribute("message", "Order status updated successfully");
        model.addAttribute("updateSuccess", true);

        return "orderList";
    }

    @GetMapping("/order")
    public String getOrder(@RequestParam("groceryId") String groceryId, Model model) {
        Groceries grocery = groceryService.getGroceryById(groceryId);
        model.addAttribute("grocery", grocery);
        return "order-details";
    }

    @PostMapping("/submit")
    public String submitOrder(@ModelAttribute Order order, 
                              @RequestParam("grocery_id") String groceryId, 
                              @RequestParam("quantity") int quantity, 
                              @RequestParam("user_id") String userId, 
                              HttpSession session, 
                              Model model) {
        Order newOrder = orderService.createOrder(groceryId, quantity, userId);

        session.setAttribute("orderId", newOrder);

        List<Order> cart = (List<Order>) session.getAttribute("cart");
        if (cart == null) {
            cart = new ArrayList<>();
        }
        cart.add(newOrder);
        session.setAttribute("cart", cart);

        BigDecimal totalAmount = orderService.calculateTotalAmount(cart);

        model.addAttribute("cart", cart);
        model.addAttribute("totalAmount", totalAmount);

        return "addToCart";
    }

    @PostMapping("/addQuantity")
    public String addQuantity(@RequestParam("index") int index, HttpSession session, Model model) {
        List<Order> cart = (List<Order>) session.getAttribute("cart");
        orderService.increaseOrderQuantity(cart, index);
        session.setAttribute("cart", cart);

        BigDecimal totalAmount = orderService.calculateTotalAmount(cart);
        model.addAttribute("totalAmount", totalAmount);

        return "redirect:/orders/cart";
    }

    @PostMapping("/reduceQuantity")
    public String reduceQuantity(@RequestParam("index") int index, HttpSession session, Model model) {
        List<Order> cart = (List<Order>) session.getAttribute("cart");
        orderService.decreaseOrderQuantity(cart, index);
        session.setAttribute("cart", cart);

        BigDecimal totalAmount = orderService.calculateTotalAmount(cart);
        model.addAttribute("totalAmount", totalAmount);

        return "redirect:/orders/cart";
    }

    @PostMapping("/remove")
    public String removeFromCart(@RequestParam("index") int index, HttpSession session, Model model) {
        List<Order> cart = (List<Order>) session.getAttribute("cart");
        if (cart != null && index >= 0 && index < cart.size()) {
            cart.remove(index);
            session.setAttribute("cart", cart);
        }
        BigDecimal totalAmount = orderService.calculateTotalAmount(cart);
        model.addAttribute("totalAmount", totalAmount);
        return "redirect:/orders/cart";
    }

    @GetMapping("/cart")
    public String viewCart(HttpSession session, Model model) {
        List<Order> cart = (List<Order>) session.getAttribute("cart");
        BigDecimal totalAmount = orderService.calculateTotalAmount(cart);

        model.addAttribute("cart", cart);
        model.addAttribute("totalAmount", totalAmount);

        return "addToCart";
    }

    @PostMapping("/checkout")
    public String checkout(HttpSession session, Model model) {
        List<Order> cart = (List<Order>) session.getAttribute("cart");
        if (cart == null || cart.isEmpty()) {
            model.addAttribute("message", "No items in the cart");
            return "addToCart";
        }

        BigDecimal totalAmount = orderService.calculateTotalAmount(cart);

        session.setAttribute("cart", cart);
        session.setAttribute("totalAmount", totalAmount);

        return "redirect:/payment?totalAmount=" + totalAmount;
    }
}
